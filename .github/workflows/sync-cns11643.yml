name: Sync CNS11643 Data

on:
  # 每週日 UTC 00:00 檢查（台灣時間週日早上 8:00）
  schedule:
    - cron: '0 0 * * 0'

  # 手動觸發
  workflow_dispatch:
    inputs:
      force_download:
        description: '強制重新下載所有檔案'
        type: boolean
        default: false

env:
  DATA_GOV_API_URL: https://data.gov.tw/api/v2/rest/dataset/5961
  CNS11643_BASE_URL: https://www.cns11643.gov.tw/opendata

# 授予 workflow 寫入權限（用於建立 PR 和 Issue）
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
      api_modified_date: ${{ steps.check.outputs.api_modified_date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Check for updates
        id: check
        run: python scripts/check_update.py
        env:
          DATA_GOV_API_URL: ${{ env.DATA_GOV_API_URL }}
          FORCE_DOWNLOAD: ${{ github.event.inputs.force_download }}

  download-and-sync:
    needs: check-update
    if: needs.check-update.outputs.has_update == 'true'
    runs-on: ubuntu-latest
    env:
      NEW_VERSION: ${{ needs.check-update.outputs.new_version }}
      CURRENT_VERSION: ${{ needs.check-update.outputs.current_version }}
      API_MODIFIED_DATE: ${{ needs.check-update.outputs.api_modified_date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests python-dotenv

      - name: Download and extract files
        run: python scripts/sync_cns11643.py
        env:
          CNS11643_BASE_URL: ${{ env.CNS11643_BASE_URL }}

      - name: Verify data integrity
        run: python scripts/verify_data.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        env:
          PR_TITLE: "chore: CNS11643 資料更新至 ${{ env.NEW_VERSION }}"
          PR_BRANCH: "sync/cns11643-${{ env.NEW_VERSION }}"
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: sync CNS11643 data to ${{ env.NEW_VERSION }}

            Previous version: ${{ env.CURRENT_VERSION }}
            New version: ${{ env.NEW_VERSION }}

            Source: https://data.gov.tw/dataset/5961
          branch: ${{ env.PR_BRANCH }}
          delete-branch: true
          title: ${{ env.PR_TITLE }}
          body: |
            ## 資料更新

            CNS11643 全字庫資料已更新。

            | 項目 | 值 |
            |------|-----|
            | 前版本 | `${{ env.CURRENT_VERSION }}` |
            | 新版本 | `${{ env.NEW_VERSION }}` |
            | 資料來源 | [政府資料開放平台](https://data.gov.tw/dataset/5961) |

            ## 變更內容

            請檢視 `release.txt` 了解詳細變更內容。

            ## 驗證步驟

            - [ ] 檢視 release.txt 變更日誌
            - [ ] 確認檔案完整性（SHA256）
            - [ ] 執行測試確認無誤

            ---
            *此 PR 由 GitHub Actions 自動建立*
          labels: |
            data-sync
            automated

  notify-failure:
    needs: [check-update, download-and-sync]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create Issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'CNS11643 資料同步失敗',
              body: `## 同步失敗通知\n\n同步作業於 ${new Date().toISOString()} 失敗。\n\n請查看 [Workflow 執行記錄](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'data-sync']
            });
